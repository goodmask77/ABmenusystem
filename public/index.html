<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>菜單管理系統</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Supabase 配置（直接嵌入，確保在 Vercel 上可用）
        window.SUPABASE_CONFIG = {
            supabaseUrl: "https://rpbnexbvxgbjzslrunya.supabase.co",
            supabaseAnonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwYm5leGJ2eGdianpzbHJ1bnlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2NzM3NTUsImV4cCI6MjA3ODI0OTc1NX0.tYWUb6ZmEPGCUYeHnQwE0PHlFBEzu-Mkcqm3kF_tKOg"
        };
    </script>
</head>
<body>
    <div class="app">
        <!-- 頂部工具列 -->
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-utensils"></i> 菜單管理系統</h1>
                <div class="header-controls">
                    <button id="toggleMode" class="btn btn-mode">
                        <i class="fas fa-toggle-off"></i>
                        <span>切換至後台</span>
                    </button>
                    <button id="loadMenu" class="btn btn-secondary">
                        <i class="fas fa-folder-open"></i> 載入菜單
                    </button>
                    <button id="viewChangeLog" class="btn btn-secondary">
                        <i class="fas fa-history"></i> 修改紀錄
                    </button>
                    <button id="manageAccounts" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-users-cog"></i> 帳號管理
                    </button>
                    <button id="loginButton" class="btn btn-secondary">
                        <i class="fas fa-user-lock"></i> 登入後台
                    </button>
                </div>
            </div>
        </header>

        <div class="main-container">
            <!-- 左側菜單區域 -->
            <div class="menu-section">
                <div class="section-header">
                    <h2>菜單管理</h2>
                    <div class="admin-controls" style="display: none;">
                        <button id="addCategory" class="btn btn-add">
                            <i class="fas fa-plus"></i> 新增類別
                        </button>
                        <button id="importMenu" class="btn btn-import">
                            <i class="fas fa-upload"></i> 批量匯入
                        </button>
                    </div>
                </div>

                <!-- 類別篩選器 -->
                <div class="category-filter">
                    <div id="categoryTabs" class="category-tabs">
                        <!-- 類別標籤將動態生成 -->
                    </div>
                </div>

                <!-- 菜單類別容器 -->
                <div id="menuCategories" class="menu-categories">
                    <!-- 類別將動態生成 -->
                </div>
            </div>

            <!-- 右側購物車區域 -->
            <div class="cart-section">
                <div class="section-header">
                    <h2><i class="fas fa-shopping-cart"></i> 購物車</h2>
                    <button id="clearCart" class="btn btn-clear">
                        <i class="fas fa-trash-alt"></i> 清除菜單
                    </button>
                </div>

                <div id="cartItems" class="cart-items">
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>購物車是空的</p>
                        <small>點擊菜單品項來新增</small>
                    </div>
                </div>

                <div class="cart-summary">
                    <!-- 客戶資訊區域 - 整合版 -->
                    <div class="order-info-section">
                        <div class="order-info-grid">
                            <!-- 第一行：基本資訊 -->
                            <div class="order-field">
                                <label>公司名稱:</label>
                                <input type="text" id="companyName" class="input-field" placeholder="選填">
                        </div>
                            <div class="order-field">
                                <label>統一編號:</label>
                            <input type="text" id="customerTaxId" class="input-field" placeholder="選填">
                        </div>
                            <div class="order-field">
                                <label>姓名:</label>
                                <input type="text" id="contactName" class="input-field" placeholder="選填">
                            </div>
                            <div class="order-field">
                                <label>手機:</label>
                                <input type="tel" id="contactPhone" class="input-field" placeholder="選填">
                            </div>
                            
                            <!-- 第二行：方案和LINE -->
                            <div class="order-field">
                                <label>方案:</label>
                                <div style="display: flex; gap: 0.3rem;">
                                    <div class="customizable-select-wrapper" style="flex: 1;">
                                    <select id="planType" class="input-field">
                                        <option value="">請選擇</option>
                                    </select>
                                    </div>
                                    <button id="managePlanType" class="btn btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;" title="管理方案">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="order-field">
                                <label>LINE名稱:</label>
                                <input type="text" id="lineName" class="input-field" placeholder="選填">
                            </div>
                            <div class="order-field">
                                <label>產業別:</label>
                                <div style="display: flex; gap: 0.3rem;">
                                    <div class="customizable-select-wrapper" style="flex: 1;">
                                        <select id="industrySelect" class="input-field">
                                            <option value="">請選擇</option>
                                        </select>
                                    </div>
                                    <button id="manageIndustry" class="btn btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;" title="管理產業別">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="order-field">
                                <label>包場內容:</label>
                                <div style="display: flex; gap: 0.3rem;">
                                    <div class="customizable-select-wrapper" style="flex: 1;">
                                        <select id="venueContentSelect" class="input-field">
                                            <option value="">請選擇</option>
                                        </select>
                                    </div>
                                    <button id="manageVenueContent" class="btn btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;" title="管理包場內容">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="order-field datetime-field">
                                <label>用餐日期時間:</label>
                                <div style="display: flex; gap: 0.3rem; align-items: center;">
                                    <input type="date" id="diningDate" class="input-field date-input" style="flex: 1;">
                                    <select id="diningHour" class="input-field time-select" style="width: 60px;">
                                <option value="">時</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                                <option value="16">16</option>
                                <option value="17">17</option>
                                <option value="18">18</option>
                                <option value="19">19</option>
                                <option value="20">20</option>
                                <option value="21">21</option>
                                <option value="22">22</option>
                                        <option value="__CUSTOM__">其他（自訂）</option>
                            </select>
                                    <input type="number" id="diningHourCustom" class="input-field custom-input" placeholder="時" min="0" max="23" style="display: none; width: 60px; margin-top: 0.3rem;">
                                    <span>:</span>
                                    <select id="diningMinute" class="input-field time-select" style="width: 60px;">
                                <option value="">分</option>
                                <option value="00">00</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="30">30</option>
                                <option value="40">40</option>
                                <option value="50">50</option>
                            </select>
                                </div>
                            </div>
                            
                            <!-- 第三行：其他選項 -->
                            <div class="order-field">
                                <label>包場範圍:</label>
                                <div style="display: flex; gap: 0.3rem;">
                                    <div class="customizable-select-wrapper" style="flex: 1;">
                                        <select id="venueScope" class="input-field">
                                            <option value="">請選擇</option>
                                        </select>
                                    </div>
                                    <button id="manageVenueScope" class="btn btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;" title="管理包場範圍">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="order-field">
                                <label>用餐方式:</label>
                                <div style="display: flex; gap: 0.3rem;">
                                    <div class="customizable-select-wrapper" style="flex: 1;">
                                        <select id="diningStyle" class="input-field">
                                            <option value="">請選擇</option>
                                        </select>
                                    </div>
                                    <button id="manageDiningStyle" class="btn btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;" title="管理用餐方式">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="order-field">
                                <label>付款:</label>
                                <div style="display: flex; gap: 0.3rem;">
                                    <div class="customizable-select-wrapper" style="flex: 1;">
                                        <select id="paymentMethod" class="input-field">
                                            <option value="">請選擇</option>
                                        </select>
                                    </div>
                                    <button id="managePaymentMethod" class="btn btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;" title="管理付款方式">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="order-field">
                                <label>折扣（% 或 金額）:</label>
                                <input type="text" id="discount" class="input-field" placeholder="例如 10% 或 500">
                            </div>
                            <div class="order-field">
                                <label>已付訂金:</label>
                                <input type="number" id="depositPaid" class="input-field" placeholder="0" min="0" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- 小計、服務費、總計放同一行 -->
                    <div class="summary-inline">
                        <div class="summary-item">
                            <span>小計:</span>
                            <span id="subtotal">$0</span>
                        </div>
                        <div class="summary-item">
                            <span>服務費(10%):</span>
                            <span id="serviceFee">$0</span>
                        </div>
                        <div class="summary-item total">
                            <span>總計:</span>
                            <span id="total">$0</span>
                        </div>
                    </div>

                    <!-- 新的控制區域 -->
                    <div class="cart-controls">
                        <div class="control-row">
                            <div class="control-item">
                                <label>桌數:</label>
                                <div class="counter-controls">
                                    <button id="decreaseTable" class="btn-counter">-</button>
                                    <input type="number" id="tableCount" value="1" min="1" max="99">
                                    <button id="increaseTable" class="btn-counter">+</button>
                                </div>
                            </div>
                            <div class="control-item">
                                <label>用餐人數:</label>
                                <div class="counter-controls">
                                    <button id="decreasePeople" class="btn-counter">-</button>
                                    <input type="number" id="peopleCount" value="1" min="1" max="99">
                                    <button id="increasePeople" class="btn-counter">+</button>
                                </div>
                            </div>
                            <div class="control-item">
                                <label>人均:</label>
                                <div class="per-person-display">
                                    <span id="perPerson">$0</span>
                                </div>
                            </div>
                        </div>
                        <div class="total-items-row">
                            <span>總餐點數量: <span id="totalItems">0</span> 道</span>
                        </div>
                    </div>

                    <!-- 分析欄位：插入在「總餐點數量」下方，匯出按鈕上方 -->
                    <section class="analysis-panel" id="analysisPanel">
                        <div class="analysis-row">
                            <div class="analysis-item">
                                <label for="customerBudget">客戶預算：</label>
                                <input id="customerBudget" type="number" min="0" step="1" placeholder="輸入數字" />
                            </div>

                            <div class="analysis-item">
                                <span class="analysis-label">餐點金額：</span>
                                <span class="analysis-value" id="foodTotal">$0</span>
                            </div>

                            <div class="analysis-item">
                                <span class="analysis-label">餐點人均：</span>
                                <span class="analysis-value" id="foodPerPerson">$0</span>
                            </div>
                        </div>

                        <div class="analysis-row">
                            <div class="analysis-item">
                                <span class="analysis-label">剩餘金額：</span>
                                <span class="analysis-value" id="remainingBudget">$0</span>
                            </div>

                            <div class="analysis-item">
                                <span class="analysis-label">酒水金額：</span>
                                <span class="analysis-value" id="drinkTotal">$0</span>
                            </div>

                            <div class="analysis-item">
                                <span class="analysis-label">酒水人均：</span>
                                <span class="analysis-value" id="drinkPerPerson">$0</span>
                            </div>
                        </div>
                    </section>

                    <div class="cart-export-controls" style="margin-top: 0.8rem; display: flex; gap: 0.4rem;">
                        <button id="exportCartExcel" class="btn btn-export" style="flex: 1;">
                            <i class="fas fa-file-excel"></i> 匯出Excel
                        </button>
                        <button id="exportCartImage" class="btn btn-export" style="flex: 1;">
                            <i class="fas fa-image"></i> 匯出圖片
                        </button>
                    </div>
                    <!-- 儲存/更新菜單按鈕 -->
                    <div class="action-row" style="margin-top: 0.8rem;">
                        <button id="updateOrder" class="btn btn-primary action-btn" style="display: none;" title="更新目前編輯的訂單">
                            <i class="fas fa-sync-alt"></i> 更新訂單
                        </button>
                        <button id="saveMenu" class="btn btn-primary action-btn" style="flex: 1;">
                            <i class="fas fa-save"></i> <span id="saveMenuButtonText">儲存菜單</span>
                        </button>
                        <button id="deleteOrder" class="btn btn-danger action-btn action-btn--danger" style="display: none;" title="刪除目前訂單">
                            <i class="fas fa-trash"></i> 刪除
                        </button>
                    </div>
                    <!-- 歷史訂單分析按鈕 -->
                    <button id="showAnalysis" class="btn btn-secondary" style="width: 100%; margin-top: 0.4rem;">
                        <i class="fas fa-chart-bar"></i> 歷史訂單分析
                    </button>
                    <!-- 建立測試訂單按鈕（開發用） -->
                    <button id="createTestOrdersBtn" class="btn btn-secondary" style="width: 100%; margin-top: 0.4rem; background: #6c757d; font-size: 0.85rem;">
                        <i class="fas fa-vial"></i> 建立測試訂單（20筆）
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增類別對話框 -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增類別</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="categoryName" placeholder="類別名稱" class="input-field">
            </div>
            <div class="modal-footer">
                <button id="saveCategoryBtn" class="btn btn-primary">儲存</button>
                <button class="btn btn-secondary close">取消</button>
            </div>
        </div>
    </div>

    <!-- 新增編輯品項對話框 -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="itemModalTitle">新增品項</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="itemName" placeholder="品項名稱" class="input-field">
                <input type="text" id="itemNameEn" placeholder="英文名稱（可選）" class="input-field">
                <textarea id="itemDescription" placeholder="品項描述" class="input-field"></textarea>
                <input type="number" id="itemPrice" placeholder="價格" class="input-field" min="0">
            </div>
            <div class="modal-footer">
                <button id="saveItemBtn" class="btn btn-primary">儲存</button>
                <button class="btn btn-secondary close">取消</button>
            </div>
        </div>
    </div>

    <!-- 匯入對話框 -->
    <div id="importModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>批量匯入菜單</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="import-format">
                    <h4>匯入格式說明：</h4>
                    <pre>產品類別
中文名稱 英文名稱 價格
中文名稱 英文名稱 價格

產品類別2
中文名稱 英文名稱 價格</pre>
                </div>
                <textarea id="importText" placeholder="請貼上菜單資料..." class="input-field import-textarea"></textarea>
                <div class="import-options">
                    <label>
                        <input type="radio" name="importMode" value="update" checked> 更新重複項目
                    </label>
                    <label>
                        <input type="radio" name="importMode" value="skip"> 跳過重複項目
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="processImportBtn" class="btn btn-primary">匯入</button>
                <button class="btn btn-secondary close">取消</button>
            </div>
        </div>
    </div>

    <!-- 儲存菜單對話框 -->
    <div id="saveMenuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>儲存菜單</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>客戶名稱:</label>
                    <div id="saveMenuCustomerName" style="color: #212529; font-weight: 600;">未填寫</div>
                </div>
                <div class="form-group">
                    <label>用餐日期時間:</label>
                    <div id="saveMenuDiningDateTime" style="color: #212529;">未設定</div>
                </div>
                <div class="form-group">
                    <label>目前狀態:</label>
                    <div style="color: #6c757d; font-size: 0.9rem;">
                        餐點數: <span id="saveMenuItemCount">0</span> 項 |
                        總計: $<span id="saveMenuTotal">0</span> |
                        人數: <span id="saveMenuPeople">1</span>人
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirmSaveMenu" class="btn btn-primary">確認儲存</button>
                <button class="btn btn-secondary close">取消</button>
            </div>
        </div>
    </div>

    <!-- 菜單歷史對話框 -->
    <div id="historyModal" class="modal history-modal">
        <div class="modal-content extra-large">
            <button class="close" onclick="closeModal('historyModal')">&times;</button>
            <h2>菜單歷史紀錄</h2>

            <div class="history-controls">
                <input type="text" id="historySearch" placeholder="搜索歷史紀錄..." oninput="renderHistoryList()">
                <select id="historyIndustryFilter">
                    <option value="">全部產業</option>
                </select>
                <select id="historySortBy" onchange="renderHistoryList()">
                    <option value="newest">最新建立</option>
                    <option value="oldest">最舊建立</option>
                    <option value="name">名稱排序</option>
                    <option value="items">項目數量</option>
                    <option value="people">人數排序</option>
                    <option value="tables">桌數排序</option>
                    <option value="total">總價排序</option>
                </select>
            </div>

            <div id="historyList" class="history-table-container"></div>
        </div>
    </div>

    <!-- 歷史訂單分析對話框 -->
    <div id="analysisModal" class="modal">
        <div class="modal-content extra-large">
            <button class="close" onclick="closeModal('analysisModal')">&times;</button>
            <h2>歷史訂單分析</h2>
            <div id="analysisContent" class="analysis-content">
                <div class="loading-analysis"><i class="fas fa-spinner fa-spin"></i> 載入分析資料中...</div>
            </div>
        </div>
    </div>

    <!-- 修改紀錄對話框 -->
    <div id="changeLogModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>修改紀錄</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="changeLogContent" class="change-log-content">
                    <div class="change-log-empty">尚未載入變更紀錄。</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 後台登入對話框 -->
    <div id="loginModal" class="modal">
        <div class="modal-content small">
            <button class="close" onclick="closeModal('loginModal')">&times;</button>
            <h3>後台登入</h3>
            <p class="modal-description">輸入授權帳號即可進入後台，無需密碼。</p>
            <input type="text" id="loginUsername" class="input-field" placeholder="請輸入帳號名稱">
            <div class="modal-footer">
                <button id="confirmLogin" class="btn btn-primary">登入</button>
                <button class="btn btn-secondary" onclick="closeModal('loginModal')">取消</button>
            </div>
        </div>
    </div>

    <!-- 帳號管理對話框 -->
    <div id="accountModal" class="modal">
        <div class="modal-content large">
            <button class="close" onclick="closeModal('accountModal')">&times;</button>
            <h3>帳號管理</h3>
            <div class="account-manager">
                <div class="account-list" id="accountList"></div>
                <div class="account-form">
                    <input type="text" id="newAccountName" class="input-field" placeholder="輸入新帳號">
                    <select id="newAccountRole" class="input-field">
                        <option value="editor">一般使用者</option>
                        <option value="admin">管理員</option>
                    </select>
                    <button id="addAccountButton" class="btn btn-primary">新增帳號</button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js" defer></script>
</body>
</html>
