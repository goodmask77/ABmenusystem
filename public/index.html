<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>菜單管理系統</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body>
    <div class="app">
        <!-- 頂部工具列 -->
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-utensils"></i> 菜單管理系統</h1>
                <div class="header-controls">
                    <button id="toggleMode" class="btn btn-mode">
                        <i class="fas fa-toggle-off"></i>
                        <span>切換至後台</span>
                    </button>
                    <button id="loadMenu" class="btn btn-secondary">
                        <i class="fas fa-folder-open"></i> 載入菜單
                    </button>
                    <button id="viewChangeLog" class="btn btn-secondary">
                        <i class="fas fa-history"></i> 修改紀錄
                    </button>
                    <button id="manageAccounts" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-users-cog"></i> 帳號管理
                    </button>
                    <button id="loginButton" class="btn btn-secondary">
                        <i class="fas fa-user-lock"></i> 登入後台
                    </button>
                </div>
            </div>
        </header>

        <div class="main-container">
            <!-- 左側菜單區域 -->
            <div class="menu-section">
                <div class="section-header">
                    <h2>菜單管理</h2>
                    <div class="admin-controls" style="display: none;">
                        <button id="addCategory" class="btn btn-add">
                            <i class="fas fa-plus"></i> 新增類別
                        </button>
                        <button id="importMenu" class="btn btn-import">
                            <i class="fas fa-upload"></i> 批量匯入
                        </button>
                    </div>
                </div>

                <!-- 類別篩選器 -->
                <div class="category-filter">
                    <div id="categoryTabs" class="category-tabs">
                        <!-- 類別標籤將動態生成 -->
                    </div>
                </div>

                <!-- 菜單類別容器 -->
                <div id="menuCategories" class="menu-categories">
                    <!-- 類別將動態生成 -->
                </div>
            </div>

            <!-- 右側購物車區域 -->
            <div class="cart-section">
                <div class="section-header">
                    <h2><i class="fas fa-shopping-cart"></i> 購物車</h2>
                    <button id="clearCart" class="btn btn-clear">
                        <i class="fas fa-trash-alt"></i> 清除菜單
                    </button>
                </div>

                <div id="cartItems" class="cart-items">
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>購物車是空的</p>
                        <small>點擊菜單品項來新增</small>
                    </div>
                </div>

                <div class="cart-summary">
                    <!-- 客戶資訊區域 - 緊湊版 -->
                    <div class="order-info-section">
                        <!-- 第一行：公司/姓名/手機 -->
                        <div class="info-row">
                            <div class="info-field flex-2">
                                <label>公司:</label>
                                <input type="text" id="companyName" class="input-sm" placeholder="公司名稱">
                            </div>
                            <div class="info-field">
                                <label>統編:</label>
                                <input type="text" id="customerTaxId" class="input-sm" placeholder="選填">
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-field">
                                <label>姓名:</label>
                                <input type="text" id="customerName" class="input-sm" placeholder="聯絡人">
                            </div>
                            <div class="info-field">
                                <label>手機:</label>
                                <input type="tel" id="customerPhone" class="input-sm" placeholder="手機號碼">
                            </div>
                            <div class="info-field industry-field">
                                <label>產業:</label>
                                <select id="industrySelect" class="input-sm">
                                    <option value="">選擇產業</option>
                                </select>
                                <button type="button" id="manageIndustry" class="btn-icon-sm" title="管理產業選項">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                        </div>
                        <!-- 第二行：用餐日期時間 -->
                        <div class="info-row">
                            <div class="info-field">
                                <label>用餐:</label>
                                <input type="date" id="diningDate" class="input-sm">
                            </div>
                            <div class="info-field time-field">
                                <select id="diningHour" class="input-sm time-select">
                                    <option value="">時</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                    <option value="17">17</option>
                                    <option value="18">18</option>
                                    <option value="19">19</option>
                                    <option value="20">20</option>
                                    <option value="21">21</option>
                                    <option value="22">22</option>
                                </select>
                                <span>:</span>
                                <select id="diningMinute" class="input-sm time-select">
                                    <option value="">分</option>
                                    <option value="00">00</option>
                                    <option value="30">30</option>
                                </select>
                            </div>
                            <div class="info-field">
                                <label>包場:</label>
                                <select id="venueScope" class="input-sm">
                                    <option value="">選擇</option>
                                    <option value="全包">全包</option>
                                    <option value="叢林區">叢林區</option>
                                    <option value="蘆葦區">蘆葦區</option>
                                </select>
                            </div>
                        </div>
                        <!-- 第三行：用餐方式/付款/訂金 -->
                        <div class="info-row">
                            <div class="info-field">
                                <label>方式:</label>
                                <select id="diningStyle" class="input-sm">
                                    <option value="">選擇</option>
                                    <option value="自助">自助</option>
                                    <option value="桌菜">桌菜</option>
                                </select>
                            </div>
                            <div class="info-field">
                                <label>付款:</label>
                                <select id="paymentMethod" class="input-sm">
                                    <option value="">選擇</option>
                                    <option value="匯款">匯款</option>
                                    <option value="刷卡">刷卡</option>
                                    <option value="當天結帳">當天結帳</option>
                                </select>
                            </div>
                            <div class="info-field">
                                <label>訂金:</label>
                                <input type="number" id="depositPaid" class="input-sm" placeholder="0" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- 小計、服務費、總計放同一行 -->
                    <div class="summary-inline">
                        <div class="summary-item">
                            <span>小計:</span>
                            <span id="subtotal">$0</span>
                        </div>
                        <div class="summary-item">
                            <span>服務費(10%):</span>
                            <span id="serviceFee">$0</span>
                        </div>
                        <div class="summary-item total">
                            <span>總計:</span>
                            <span id="total">$0</span>
                        </div>
                    </div>

                    <!-- 新的控制區域 -->
                    <div class="cart-controls">
                        <div class="control-row">
                            <div class="control-item">
                                <label>桌數:</label>
                                <div class="counter-controls">
                                    <button id="decreaseTable" class="btn-counter">-</button>
                                    <input type="number" id="tableCount" value="1" min="1" max="99">
                                    <button id="increaseTable" class="btn-counter">+</button>
                                </div>
                            </div>
                            <div class="control-item">
                                <label>用餐人數:</label>
                                <div class="counter-controls">
                                    <button id="decreasePeople" class="btn-counter">-</button>
                                    <input type="number" id="peopleCount" value="1" min="1" max="99">
                                    <button id="increasePeople" class="btn-counter">+</button>
                                </div>
                            </div>
                            <div class="control-item">
                                <label>人均:</label>
                                <div class="per-person-display">
                                    <span id="perPerson">$0</span>
                                </div>
                            </div>
                        </div>
                        <div class="total-items-row">
                            <span>總餐點數量: <span id="totalItems">0</span> 道</span>
                        </div>
                    </div>
                    <div class="cart-export-controls" style="margin-top: 0.8rem; display: flex; gap: 0.4rem;">
                        <button id="exportCartExcel" class="btn btn-export" style="flex: 1;">
                            <i class="fas fa-file-excel"></i> 匯出Excel
                        </button>
                        <button id="exportCartImage" class="btn btn-export" style="flex: 1;">
                            <i class="fas fa-image"></i> 匯出圖片
                        </button>
                    </div>
                    <!-- 儲存菜單按鈕 -->
                    <button id="saveMenu" class="btn btn-primary btn-save-menu">
                        <i class="fas fa-save"></i> 儲存菜單
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增類別對話框 -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增類別</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="categoryName" placeholder="類別名稱" class="input-field">
            </div>
            <div class="modal-footer">
                <button id="saveCategoryBtn" class="btn btn-primary">儲存</button>
                <button class="btn btn-secondary close">取消</button>
            </div>
        </div>
    </div>

    <!-- 新增編輯品項對話框 -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="itemModalTitle">新增品項</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="itemName" placeholder="品項名稱" class="input-field">
                <input type="text" id="itemNameEn" placeholder="英文名稱（可選）" class="input-field">
                <textarea id="itemDescription" placeholder="品項描述" class="input-field"></textarea>
                <input type="number" id="itemPrice" placeholder="價格" class="input-field" min="0">
            </div>
            <div class="modal-footer">
                <button id="saveItemBtn" class="btn btn-primary">儲存</button>
                <button class="btn btn-secondary close">取消</button>
            </div>
        </div>
    </div>

    <!-- 匯入對話框 -->
    <div id="importModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>批量匯入菜單</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="import-format">
                    <h4>匯入格式說明：</h4>
                    <pre>產品類別
中文名稱 英文名稱 價格
中文名稱 英文名稱 價格

產品類別2
中文名稱 英文名稱 價格</pre>
                </div>
                <textarea id="importText" placeholder="請貼上菜單資料..." class="input-field import-textarea"></textarea>
                <div class="import-options">
                    <label>
                        <input type="radio" name="importMode" value="update" checked> 更新重複項目
                    </label>
                    <label>
                        <input type="radio" name="importMode" value="skip"> 跳過重複項目
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="processImportBtn" class="btn btn-primary">匯入</button>
                <button class="btn btn-secondary close">取消</button>
            </div>
        </div>
    </div>

    <!-- 儲存菜單對話框 -->
    <div id="saveMenuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>儲存菜單</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>客戶名稱:</label>
                    <div id="saveMenuCustomerName" style="color: #212529; font-weight: 600;">未填寫</div>
                </div>
                <div class="form-group">
                    <label>用餐日期時間:</label>
                    <div id="saveMenuDiningDateTime" style="color: #212529;">未設定</div>
                </div>
                <div class="form-group">
                    <label>目前狀態:</label>
                    <div style="color: #6c757d; font-size: 0.9rem;">
                        餐點數: <span id="saveMenuItemCount">0</span> 項 |
                        總計: $<span id="saveMenuTotal">0</span> |
                        人數: <span id="saveMenuPeople">1</span>人
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirmSaveMenu" class="btn btn-primary">確認儲存</button>
                <button class="btn btn-secondary close">取消</button>
            </div>
        </div>
    </div>

    <!-- 菜單歷史對話框 -->
    <div id="historyModal" class="modal history-modal">
        <div class="modal-content extra-large">
            <button class="close" onclick="closeModal('historyModal')">&times;</button>
            <h2>菜單歷史紀錄</h2>

            <div class="history-controls">
                <input type="text" id="historySearch" placeholder="搜尋公司、聯絡人、餐點..." oninput="renderHistoryList()">
                <select id="historyIndustryFilter" onchange="renderHistoryList()">
                    <option value="">全部產業</option>
                </select>
                <select id="historySortBy" onchange="renderHistoryList()">
                    <option value="newest">最新建立</option>
                    <option value="oldest">最舊建立</option>
                    <option value="name">稱排序</option>
                    <option value="items">項目數量</option>
                    <option value="people">人數排序</option>
                    <option value="tables">桌數排序</option>
                    <option value="total">總價排序</option>
                </select>
            </div>

            <div id="historyList"></div>
        </div>
    </div>

    <!-- 修改紀錄對話框 -->
    <div id="changeLogModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>修改紀錄</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="changeLogContent" class="change-log-content">
                    <div class="change-log-empty">尚未載入變更紀錄。</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 後台登入對話框 -->
    <div id="loginModal" class="modal">
        <div class="modal-content small">
            <button class="close" onclick="closeModal('loginModal')">&times;</button>
            <h3>後台登入</h3>
            <p class="modal-description">輸入授權帳號即可進入後台，無需密碼。</p>
            <input type="text" id="loginUsername" class="input-field" placeholder="請輸入帳號名稱">
            <div class="modal-footer">
                <button id="confirmLogin" class="btn btn-primary">登入</button>
                <button class="btn btn-secondary" onclick="closeModal('loginModal')">取消</button>
            </div>
        </div>
    </div>

    <!-- 帳號管理對話框 -->
    <div id="accountModal" class="modal">
        <div class="modal-content large">
            <button class="close" onclick="closeModal('accountModal')">&times;</button>
            <h3>帳號管理</h3>
            <div class="account-manager">
                <div class="account-list" id="accountList"></div>
                <div class="account-form">
                    <input type="text" id="newAccountName" class="input-field" placeholder="輸入新帳號">
                    <select id="newAccountRole" class="input-field">
                        <option value="editor">一般使用者</option>
                        <option value="admin">管理員</option>
                    </select>
                    <button id="addAccountButton" class="btn btn-primary">新增帳號</button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js" defer></script>
</body>
</html>
